<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Flow - รับจ้างงานฟรีแลนซ์ครบวงจร</title>
    
    <!-- Google Site Verification Tag -->
    <meta name="google-site-verification" content="N285uTUonyzVnxui0WNbB9zO4dgUN0QNyBrugVbEZ2Y" />

    <!-- Google Fonts: Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f0f2f5; color: #1f2937; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .bento-card { background: white; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .bento-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); border-color: #d1d5db; }
        .editable-active { border: 2px dashed #3b82f6 !important; cursor: text; background-color: #eff6ff; position: relative; }
        .editable-img-active { cursor: pointer; border: 4px solid #3b82f6; opacity: 0.9; transition: all 0.2s; }
        .editable-img-active::after { content: "คลิกเพื่อเปลี่ยนรูป"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 14px; pointer-events: none; }
        .editable-file-active { border: 4px dashed #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .booking-slot { cursor: pointer; transition: all 0.2s; }
        .booking-slot:hover { transform: scale(1.05); }
        .booking-slot.booked { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .admin-mode .booking-slot.booked:hover { background-color: #fca5a5; }
        .booking-slot.available { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; items-center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-600 font-medium">กำลังโหลดข้อมูล...</p>
        <p class="text-xs text-gray-400 mt-2" id="loading-status">กำลังเชื่อมต่อฐานข้อมูล...</p>
    </div>

    <!-- Hidden Input for Images -->
    <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
    <!-- Hidden Input for General Files (PDF, etc) -->
    <input type="file" id="fileUploadInput" accept=".pdf,.doc,.docx,.zip,.jpg,.png" style="display: none;">

    <!-- Admin Tools -->
    <div class="fixed bottom-4 right-4 z-50 flex flex-col items-end gap-2">
        <button id="saveButton" onclick="saveToDatabase()" class="hidden bg-green-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-green-700 flex items-center gap-2 transition-all">
            <i class="fas fa-save"></i> <span>บันทึกการแก้ไข</span>
        </button>
        <button id="editToggle" onclick="toggleEditMode()" class="bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg hover:bg-gray-700 flex items-center gap-2 transition-all">
            <i class="fas fa-lock"></i> <span>โหมดผู้ดูแล</span>
        </button>
    </div>

    <!-- Nav -->
    <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
                    <span id="nav-brand" class="text-xl font-bold tracking-tight text-gray-900 editable" contenteditable="false">Work Flow</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="#about" class="text-gray-600 hover:text-blue-600 px-3 py-2 text-sm font-medium">เกี่ยวกับเรา</a>
                    <a href="#services" class="text-gray-600 hover:text-blue-600 px-3 py-2 text-sm font-medium">บริการ & ราคา</a>
                    <a href="#portfolio" class="text-gray-600 hover:text-blue-600 px-3 py-2 text-sm font-medium">ผลงาน</a>
                    <a href="#booking" class="text-gray-600 hover:text-blue-600 px-3 py-2 text-sm font-medium">จองคิว</a>
                    <a href="#contact" class="bg-black text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 transition">ติดต่อเรา</a>
                </div>
                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-gray-600"><i class="fas fa-bars text-2xl"></i></button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white border-b border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#about" class="block text-gray-600 px-3 py-2">เกี่ยวกับเรา</a>
                <a href="#services" class="block text-gray-600 px-3 py-2">บริการ & ราคา</a>
                <a href="#booking" class="block text-gray-600 px-3 py-2">จองคิว</a>
                <a href="#contact" class="block text-gray-600 px-3 py-2">ติดต่อเรา</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Hero -->
        <div class="bento-card mb-8 text-center py-16 bg-gradient-to-r from-gray-50 to-white relative overflow-hidden group">
            <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-blue-100 rounded-full blur-3xl opacity-50"></div>
            <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-purple-100 rounded-full blur-3xl opacity-50"></div>
            
            <h1 id="hero-title" class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight editable" contenteditable="false">เปลี่ยนงานยาก ให้เป็นงานง่าย</h1>
            <p id="hero-desc" class="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto mb-8 editable" contenteditable="false">Work Flow รับจ้างงานฟรีแลนซ์ งานนำเสนอ รายงาน และงานออนไลน์ทั่วไป โดยทีมงานมืออาชีพ รวดเร็ว และมีคุณภาพ</p>
            
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <a href="#booking" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-1">จองคิวงาน</a>
                
                <!-- ปุ่มดาวน์โหลดไฟล์ (เพิ่มใหม่) -->
                <a id="download-btn" href="#" target="_blank" class="bg-white text-gray-700 border border-gray-300 px-8 py-3 rounded-xl font-medium hover:bg-gray-50 transition flex items-center gap-2 editable-file group">
                    <i class="fas fa-file-download text-red-500"></i>
                    <span id="download-text">โหลด Company Profile</span>
                </a>
            </div>
            
            <p class="text-xs text-gray-400 mt-2 hidden admin-only-text">(ในโหมดผู้ดูแล: คลิกปุ่ม "โหลด Company Profile" เพื่ออัปโหลดไฟล์ PDF/รูป ใหม่)</p>
        </div>

        <!-- ANALYTICS DASHBOARD (Visible only to Admin) -->
        <div id="analytics-dashboard" class="hidden mb-8">
            <div class="bento-card bg-gray-900 text-white border-gray-800">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white"><i class="fas fa-chart-line text-green-400 mr-2"></i> ข้อมูลหลังบ้าน (Analytics)</h2>
                    <button onclick="refreshAnalytics()" class="text-sm bg-gray-700 px-3 py-1 rounded hover:bg-gray-600"><i class="fas fa-sync"></i> รีเฟรช</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <p class="text-gray-400 text-sm">ผู้เข้าชมทั้งหมด (โดยประมาณ)</p>
                        <p id="stat-total-views" class="text-3xl font-bold text-blue-400">Loading...</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <p class="text-gray-400 text-sm">เข้าชมล่าสุดเมื่อ</p>
                        <p id="stat-last-visit" class="text-lg font-medium text-green-400">Loading...</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <p class="text-gray-400 text-sm">ขนาดข้อมูลปัจจุบัน</p>
                        <p id="stat-db-size" class="text-lg font-medium text-yellow-400">Checking...</p>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-700 bg-gray-800">
                        <h3 class="font-bold">ประวัติการเข้าชมล่าสุด (20 รายการ)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3">เวลา</th>
                                    <th class="px-4 py-3">อุปกรณ์ (User Agent)</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-table-body">
                                <tr><td colspan="2" class="px-4 py-3 text-center">กำลังโหลดข้อมูล...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- About -->
            <div id="about" class="bento-card col-span-1 md:col-span-2 row-span-1">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i class="fas fa-info-circle"></i></div>
                    <h2 id="about-title" class="text-xl font-bold text-gray-800 editable" contenteditable="false">เกี่ยวกับ Work Flow</h2>
                </div>
                <p id="about-text" class="text-gray-600 leading-relaxed editable" contenteditable="false">เราคือกลุ่มคนทำงานรุ่นใหม่ที่เข้าใจความต้องการของลูกค้า ไม่ว่าจะเป็นงานเร่งด่วน หรืองานที่ต้องการความละเอียด เราพร้อมดูแลงานเอกสาร งานนำเสนอ และงานธุรการออนไลน์ของคุณ</p>
            </div>

            <!-- Services -->
            <div id="services" class="col-span-1 md:col-span-3 lg:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- S1 -->
                <div class="bento-card hover:border-blue-300 transition-colors group">
                    <div class="h-40 bg-gray-100 rounded-lg mb-4 overflow-hidden relative">
                         <img id="serv-img-1" src="https://placehold.co/600x400/e2e8f0/64748b?text=Presentation" class="w-full h-full object-cover editable-img">
                    </div>
                    <h3 id="serv-title-1" class="text-lg font-bold text-gray-900 mb-2 editable" contenteditable="false">งานนำเสนอ</h3>
                    <p id="serv-desc-1" class="text-gray-500 text-sm mb-4 editable" contenteditable="false">ออกแบบ PowerPoint, Canva สวยงาม</p>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                        <span class="text-xs text-gray-400">เริ่มต้น</span>
                        <span id="serv-price-1" class="text-lg font-bold text-blue-600 editable" contenteditable="false">฿500</span>
                    </div>
                </div>
                <!-- S2 -->
                <div class="bento-card hover:border-purple-300 transition-colors group">
                    <div class="h-40 bg-gray-100 rounded-lg mb-4 overflow-hidden relative">
                        <img id="serv-img-2" src="https://placehold.co/600x400/f3e8ff/7e22ce?text=Report" class="w-full h-full object-cover editable-img">
                    </div>
                    <h3 id="serv-title-2" class="text-lg font-bold text-gray-900 mb-2 editable" contenteditable="false">งานเอกสาร</h3>
                    <p id="serv-desc-2" class="text-gray-500 text-sm mb-4 editable" contenteditable="false">จัดหน้า พิมพ์งาน วิเคราะห์ข้อมูล</p>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                        <span class="text-xs text-gray-400">เริ่มต้น</span>
                        <span id="serv-price-2" class="text-lg font-bold text-purple-600 editable" contenteditable="false">฿300</span>
                    </div>
                </div>
                <!-- S3 -->
                <div class="bento-card hover:border-orange-300 transition-colors group">
                    <div class="h-40 bg-gray-100 rounded-lg mb-4 overflow-hidden relative">
                        <img id="serv-img-3" src="https://placehold.co/600x400/ffedd5/c2410c?text=Admin" class="w-full h-full object-cover editable-img">
                    </div>
                    <h3 id="serv-title-3" class="text-lg font-bold text-gray-900 mb-2 editable" contenteditable="false">งานทั่วไป</h3>
                    <p id="serv-desc-3" class="text-gray-500 text-sm mb-4 editable" contenteditable="false">ตอบแชท ประสานงาน Admin</p>
                    <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                        <span class="text-xs text-gray-400">เริ่มต้น</span>
                        <span id="serv-price-3" class="text-lg font-bold text-orange-600 editable" contenteditable="false">฿250</span>
                    </div>
                </div>
            </div>

            <!-- Portfolio -->
            <div id="portfolio" class="bento-card col-span-1 md:col-span-3 lg:col-span-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-briefcase text-gray-400"></i> ผลงานที่ผ่านมา</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative"><img id="port-img-1" src="https://placehold.co/400x400?text=Project+1" class="w-full h-full object-cover editable-img"></div>
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative"><img id="port-img-2" src="https://placehold.co/400x400?text=Project+2" class="w-full h-full object-cover editable-img"></div>
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative"><img id="port-img-3" src="https://placehold.co/400x400?text=Project+3" class="w-full h-full object-cover editable-img"></div>
                    <div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 text-gray-400">
                         <div class="text-center text-xs p-2">(เปลี่ยนรูปได้ในโหมดแก้ไข)</div>
                    </div>
                </div>
            </div>

            <!-- Booking -->
            <div id="booking" class="bento-card col-span-1 md:col-span-2 lg:col-span-3">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-calendar-alt text-blue-500"></i> ตารางคิวงาน</h2>
                    <div class="flex gap-3 text-xs">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-100 border border-green-300 rounded-full"></div> ว่าง</div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-100 border border-red-300 rounded-full"></div> คิวเต็ม</div>
                    </div>
                </div>
                <p id="booking-desc" class="text-sm text-gray-500 mb-4 editable" contenteditable="false">ในโหมดผู้ดูแล: คลิกที่วันที่เพื่อ ล็อกคิว (แดง) หรือ ปลดล็อก (เขียว) แล้วกดบันทึก</p>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm"></div>
                <div id="booking-message" class="mt-4 p-3 rounded-lg hidden text-sm font-medium text-center"></div>
            </div>

            <!-- Contact -->
            <div id="contact" class="bento-card col-span-1 md:col-span-1 lg:col-span-1 bg-gray-900 text-white border-gray-800">
                <h2 class="text-xl font-bold mb-4">ติดต่อเรา</h2>
                <div class="space-y-4">
                    <a href="https://www.facebook.com/profile.php?id=61583096235430" target="_blank" class="flex items-center gap-3 p-3 bg-white/10 rounded-xl hover:bg-blue-600 transition border border-white/10 group">
                        <i class="fab fa-facebook text-2xl group-hover:text-white text-blue-400"></i>
                        <div><p class="text-xs text-gray-400">Facebook</p><p class="font-bold">Work Flow</p></div>
                    </a>
                    <a href="tel:0982165174" class="flex items-center gap-3 p-3 bg-white/10 rounded-xl hover:bg-green-600 transition border border-white/10 group">
                        <i class="fas fa-phone-alt text-2xl group-hover:text-white text-green-400"></i>
                        <div><p class="text-xs text-gray-400">โทรศัพท์</p><p class="font-bold">098-216-5174</p></div>
                    </a>
                    <div class="pt-4 border-t border-gray-700 mt-4">
                         <p class="text-xs text-gray-500 text-center">&copy; 2026 Work Flow</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, addDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // ส่วนที่ 1: กุญแจ Firebase ของคุณ
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAfzanJaJ-9tpML1slfMAdwCF6jHWJRoyQ",
            authDomain: "work-flows-ac364.firebaseapp.com",
            projectId: "work-flows-ac364",
            storageBucket: "work-flows-ac364.firebasestorage.app",
            messagingSenderId: "1094886604901",
            appId: "1:1094886604901:web:ec9b2967b629d24d46868c",
            measurementId: "G-1KK8D48FZ7"
        };

        // --- Singleton Initialization ---
        let app;
        const appName = "WorkFlow-Production-v3";

        try {
            const existingApps = getApps();
            const existingApp = existingApps.find(a => a.name === appName);
            if (existingApp) {
                app = existingApp;
                console.log("Using existing Firebase app.");
            } else {
                app = initializeApp(firebaseConfig, appName);
                console.log("Initialized new Firebase app.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading-status').innerHTML = `<span class='text-red-500'>Init Error: ${e.message}</span>`;
        }

        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let isEditMode = false;
        let dbData = { bookedDates: [5, 12, 20, 25] }; 
        const collectionName = 'website_content';
        const documentId = 'main_data';
        const analyticsCollection = 'website_analytics'; // Collection ใหม่สำหรับเก็บสถิติ
        const docRef = doc(db, collectionName, documentId);

        // เชื่อมต่อ (Anonymous Login)
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Login Error:", error);
                document.getElementById('loading-overlay').innerHTML = `<div class='text-center p-4 bg-white rounded-xl text-red-600 font-bold'>Login Error: ${error.message}<br><span class='text-sm text-gray-500 font-normal'>กรุณาเปิด Anonymous Auth ใน Firebase Console</span></div>`;
            }
        };

        initAuth();

        // ฟังการเปลี่ยนแปลงข้อมูล (Real-time)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Log visit once per session load
                logVisit();

                onSnapshot(docRef, (snapshot) => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    if (snapshot.exists()) {
                        dbData = snapshot.data();
                        renderContent(dbData);
                    } else {
                        // ถ้าเปิดครั้งแรก ยังไม่มีข้อมูล ให้สร้างข้อมูลเริ่มต้น
                        saveToDatabase(true); 
                    }
                }, (error) => {
                    if (error.code === 'permission-denied') {
                        document.getElementById('loading-overlay').innerHTML = "<div class='text-center p-4 bg-white rounded-xl text-red-600 font-bold'>Error: Permission Denied<br><span class='text-sm text-gray-500 font-normal'>อย่าลืมไปตั้งค่า Firestore Rules เป็น 'allow read, write: if true;'</span></div>";
                    } else {
                         console.error("Snapshot Error:", error);
                    }
                });
            }
        });

        // --- Analytics System ---
        async function logVisit() {
            try {
                // บันทึกการเข้าชมลงใน Collection ใหม่
                await addDoc(collection(db, analyticsCollection), {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    screenSize: `${window.screen.width}x${window.screen.height}`
                });
                console.log("Visit logged.");
            } catch (e) {
                console.warn("Analytics log failed:", e); // Non-critical
            }
        }

        window.refreshAnalytics = async () => {
            if (!isEditMode) return;
            
            const statsTotal = document.getElementById('stat-total-views');
            const statsLast = document.getElementById('stat-last-visit');
            const tbody = document.getElementById('analytics-table-body');
            
            statsTotal.innerText = "Loading...";
            
            try {
                // ดึงข้อมูล 50 รายการล่าสุด
                const q = query(collection(db, analyticsCollection), orderBy("timestamp", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                
                // อัปเดตตาราง
                tbody.innerHTML = "";
                let count = 0;
                let lastTime = "-";

                querySnapshot.forEach((doc) => {
                    count++;
                    const data = doc.data();
                    const time = new Date(data.timestamp).toLocaleString('th-TH');
                    
                    if (count === 1) lastTime = time;

                    const row = `
                        <tr class="bg-gray-800 border-b border-gray-700">
                            <td class="px-4 py-3">${time}</td>
                            <td class="px-4 py-3 text-xs truncate max-w-[200px]" title="${data.userAgent}">${simplifyUserAgent(data.userAgent)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // ประมาณการยอดรวม (ใช้ size ของ query ไม่ได้แม่นยำ 100% แต่ประหยัด quota)
                // สำหรับ Firestore เบื้องต้นเราจะแสดงจำนวนที่ดึงมา (เช่น 50+)
                statsTotal.innerText = querySnapshot.size + (querySnapshot.size === 50 ? "+" : "");
                statsLast.innerText = lastTime;
                
                // ตรวจสอบขนาดข้อมูล
                const dataSize = new Blob([JSON.stringify(dbData)]).size;
                const sizeKB = (dataSize / 1024).toFixed(2);
                const sizeColor = sizeKB > 900 ? 'text-red-500' : 'text-green-400';
                document.getElementById('stat-db-size').innerHTML = `<span class="${sizeColor}">${sizeKB} KB</span> / 1 MB Limit`;

            } catch (e) {
                console.error("Analytics Error:", e);
                tbody.innerHTML = `<tr><td colspan="2" class="text-red-400 p-4">Error loading stats: ${e.message}</td></tr>`;
            }
        };

        function simplifyUserAgent(ua) {
            if (ua.includes("iPhone")) return "iPhone";
            if (ua.includes("Android")) return "Android";
            if (ua.includes("Windows")) return "Windows PC";
            if (ua.includes("Mac")) return "Mac";
            return "Other";
        }

        // --- Render Functions ---
        function renderContent(data) {
            if(data.text) {
                for (const [id, text] of Object.entries(data.text)) {
                    const el = document.getElementById(id);
                    if (el && !isEditMode) el.innerText = text;
                }
            }
            if(data.images) {
                for (const [id, src] of Object.entries(data.images)) {
                    const el = document.getElementById(id);
                    if (el) el.src = src;
                }
            }
            if(data.files) {
                // Handle file link (Company Profile)
                const downloadBtn = document.getElementById('download-btn');
                if (data.files['download-btn'] && downloadBtn) {
                    downloadBtn.href = data.files['download-btn'];
                }
            }
            renderCalendar(data.bookedDates || []);
        }

        function renderCalendar(bookedDates) {
            const calendarGrid = document.getElementById('calendar-grid');
            const currentDate = new Date();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const startDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysHeader = ['อา','จ','อ','พ','พฤ','ศ','ส'];

            calendarGrid.innerHTML = '';
            daysHeader.forEach(d => {
                const el = document.createElement('div');
                el.className = 'text-gray-400 font-bold';
                el.innerText = d;
                calendarGrid.appendChild(el);
            });

            for(let i=0; i<startDay; i++) calendarGrid.appendChild(document.createElement('div'));

            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'p-2 rounded-lg border text-sm font-medium booking-slot';
                if (bookedDates.includes(i)) dayEl.classList.add('booked');
                else dayEl.classList.add('available');
                dayEl.onclick = () => handleDateClick(i);
                calendarGrid.appendChild(dayEl);
            }
        }

        window.handleDateClick = (day) => {
            const msg = document.getElementById('booking-message');
            if (isEditMode) {
                const index = dbData.bookedDates.indexOf(day);
                if (index > -1) dbData.bookedDates.splice(index, 1);
                else dbData.bookedDates.push(day);
                renderCalendar(dbData.bookedDates);
                msg.classList.remove('hidden');
                msg.innerHTML = `<span class='text-blue-600'>แก้ไขสถานะวันที่ ${day} แล้ว (อย่าลืมกดบันทึก)</span>`;
            } else {
                msg.classList.remove('hidden');
                if (dbData.bookedDates.includes(day)) msg.innerHTML = `<span class='text-red-600'>วันที่ ${day} คิวเต็มแล้วค่ะ</span>`;
                else msg.innerHTML = `<span class='text-green-600'>วันที่ ${day} ว่าง! <a href='https://www.facebook.com/profile.php?id=61583096235430' target='_blank' class='underline'>ทักแชทจองเลย</a></span>`;
            }
        };

        window.saveToDatabase = async (silent = false) => {
            if (!currentUser) return;
            const textData = {};
            document.querySelectorAll('.editable').forEach(el => textData[el.id] = el.innerText);
            
            const imageData = {};
            document.querySelectorAll('.editable-img').forEach(el => imageData[el.id] = el.src);

            const fileData = {};
            // Save file link if exists
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn && downloadBtn.getAttribute('href') !== '#') {
                fileData['download-btn'] = downloadBtn.getAttribute('href');
            }

            const newData = { 
                text: textData, 
                images: imageData, 
                files: fileData,
                bookedDates: dbData.bookedDates || [] 
            };
            
            try {
                // Check size before save
                const jsonString = JSON.stringify(newData);
                const sizeInBytes = new Blob([jsonString]).size;
                const sizeInMB = sizeInBytes / (1024 * 1024);

                if (sizeInMB > 0.95) {
                    alert(`คำเตือน: ขนาดข้อมูลรวมเกิน 1MB (${sizeInMB.toFixed(2)} MB)\nFirebase ไม่สามารถบันทึกได้ กรุณาลบรูปภาพบางส่วนหรือใช้ไฟล์ที่เล็กลง`);
                    return;
                }

                await setDoc(docRef, newData);
                if (!silent) alert('บันทึกข้อมูลเรียบร้อย!');
                if (isEditMode) toggleEditMode();
            } catch (error) {
                alert("เกิดข้อผิดพลาด: " + error.message);
            }
        };

        window.toggleEditMode = () => {
            const btn = document.getElementById('editToggle');
            const saveBtn = document.getElementById('saveButton');
            const body = document.body;
            const dashboard = document.getElementById('analytics-dashboard');
            const adminTexts = document.querySelectorAll('.admin-only-text');

            if (!isEditMode) {
                if (prompt("รหัสผ่านผู้ดูแล:") !== "admin") { alert("รหัสผิด"); return; }
                isEditMode = true;
                body.classList.add('admin-mode');
                dashboard.classList.remove('hidden'); // Show Analytics
                adminTexts.forEach(el => el.classList.remove('hidden'));
                
                // Load Analytics
                window.refreshAnalytics();

                document.querySelectorAll('.editable').forEach(el => { el.contentEditable = "true"; el.classList.add('editable-active'); });
                
                // Image Editing
                document.querySelectorAll('.editable-img').forEach(el => {
                    el.classList.add('editable-img-active');
                    el.onclick = function() { window.currentImageElement = this; document.getElementById('imageUploadInput').click(); };
                });

                // File Editing (Download Button)
                const fileBtn = document.getElementById('download-btn');
                if(fileBtn) {
                    fileBtn.classList.add('editable-file-active');
                    fileBtn.onclick = (e) => {
                        e.preventDefault(); // Prevent downloading when editing
                        if(confirm("ต้องการอัปโหลดไฟล์ Company Profile ใหม่หรือไม่?")) {
                            document.getElementById('fileUploadInput').click();
                        }
                    };
                }

                btn.innerHTML = '<i class="fas fa-times"></i> <span>ยกเลิก</span>';
                btn.classList.replace('bg-gray-800', 'bg-red-600');
                saveBtn.classList.remove('hidden');
            } else {
                isEditMode = false;
                body.classList.remove('admin-mode');
                dashboard.classList.add('hidden'); // Hide Analytics
                adminTexts.forEach(el => el.classList.add('hidden'));

                document.querySelectorAll('.editable').forEach(el => { el.contentEditable = "false"; el.classList.remove('editable-active'); if(dbData.text?.[el.id]) el.innerText = dbData.text[el.id]; });
                
                document.querySelectorAll('.editable-img').forEach(el => { el.classList.remove('editable-img-active'); el.onclick = null; });

                const fileBtn = document.getElementById('download-btn');
                if(fileBtn) {
                    fileBtn.classList.remove('editable-file-active');
                    fileBtn.onclick = null; // Reset to default link behavior
                }

                btn.innerHTML = '<i class="fas fa-lock"></i> <span>โหมดผู้ดูแล</span>';
                btn.classList.replace('bg-red-600', 'bg-gray-800');
                saveBtn.classList.add('hidden');
                renderCalendar(dbData.bookedDates);
            }
        };

        // Handle Image Upload (Limit 1MB per file due to Firestore Document Limit)
        document.getElementById('imageUploadInput').addEventListener('change', function(e) {
            handleFileUpload(e, 'image');
        });

        // Handle File Upload (PDF, Doc, etc.)
        document.getElementById('fileUploadInput').addEventListener('change', function(e) {
            handleFileUpload(e, 'file');
        });

        function handleFileUpload(e, type) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const maxSize = 950 * 1024; // Limit ~950KB safe zone for Firestore
                
                if (file.size > maxSize) { 
                    alert(`ไฟล์มีขนาดใหญ่เกินไป (${(file.size/1024/1024).toFixed(2)} MB)\n\nข้อจำกัดทางเทคนิค: เนื่องจากเว็บนี้ใช้ฐานข้อมูลฟรี (Firestore Document) จึงรับไฟล์ได้ไม่เกิน 1 MB ต่อการบันทึกรวมทั้งหมดครับ\n\nคำแนะนำ: โปรดบีบอัดไฟล์ PDF หรือรูปภาพให้เล็กลงก่อนอัปโหลด`); 
                    return; 
                }

                const reader = new FileReader();
                reader.onload = function(evt) {
                    if (type === 'image' && window.currentImageElement) {
                        window.currentImageElement.src = evt.target.result;
                    } else if (type === 'file') {
                        const downloadBtn = document.getElementById('download-btn');
                        downloadBtn.href = evt.target.result; // Set Base64 as href
                        // Auto update file name text if needed, or just let user edit text
                        alert("อัปโหลดไฟล์เรียบร้อย! (อย่าลืมกดบันทึก)");
                    }
                }
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>